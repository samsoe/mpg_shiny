---
title: "MPG Ranch Weather"
output:
  flexdashboard::flex_dashboard: 
    theme: bootstrap
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(plotly)
# library(bigrquery)
# library(DBI)
library(lubridate)
library(readr)
library(DT)
library(leaflet)
```

```{r load_data, include = FALSE}
weather_df <- read_csv('mpg_weather-2013_2020.csv')

stations_df <- read_csv('weather_station_location.csv')
```

Sidebar {.sidebar data-width=250}
=====================================
```{r}

dateRangeInput("date_range", 
               label = "Date range",
               start = "2013-01-01",
               end = "2020-12-31",
               max = Sys.Date() - 1,
               min = "2013-01-01")

selectInput("station",
            "Select station:",
            choices = c("Baldy Draw", "Baldy Summit", "Indian Ridge",
                        "Orchard House", "Sanfoin Bench", "South Baldy Ridge"),
            selected = c("Baldy Summit", "Orchard House"),
            multiple = TRUE)

sliderInput("day_slider", 
            label = "Day Range by Year:",
            min = 1, 
            max = 365, 
            value = c(1,365), 
            step = 1)

show_weather_df <- reactive({
  weather_df %>%
    filter(date_day >= min(input$date_range) &
            date_day <= max(input$date_range)) %>%
    filter(station %in% if(is.null(input$station)) {'Orchard House'} else {input$station})  %>%
    mutate(doy = yday(date_day)) %>%
    filter(doy >= min(input$day_slider) &
             doy <= max(input$day_slider))
        
})

show_stations_df <- reactive({
  stations_df %>%
      filter(station %in% input$station)
})

# Create placeholder for the downloadButton
uiOutput("downloadUI")

# Create the actual downloadButton
output$downloadUI <- renderUI({
  downloadButton("downBtn", "mpg_weather .csv", style = "width:100%;")
})

# Add download handling
output$downBtn <- downloadHandler(
  filename = function() {
    paste('mpg_weather-', min(input$date_range), '_', max(input$date_range), '.csv', sep='')
  },
  content = function(file) {
    write.csv(show_weather_df(), file, row.names = FALSE)
  }
)
```

Plots
=====================================

Column {.tabset data-width=750}
-----------------
### Temperature

```{r}

renderPlot({
  show_weather_df() %>%
    select(date_day, station, temp_F_mean) %>%
    arrange(date_day) %>%
    mutate(year = year(date_day), doy = yday(date_day)) %>%
    group_by(year, station) %>%
    ungroup() %>%
    ggplot(aes(x=doy, y=temp_F_mean)) +
    geom_line(aes(colour = station)) +
    facet_grid(vars(year)) +
    labs(x = "", y = "Temperature (F)") +
    scale_x_continuous(labels = function(x) format(as.Date(as.character(x), "%j"), "%b-%d")) +
    theme(legend.position="top") +
    labs(color = "Station")
})

```

### Precipitation

```{r}
renderPlot({
  show_weather_df() %>%
    arrange(date_day) %>%
    mutate(year = year(date_day), doy = yday(date_day)) %>%
    group_by(year, station) %>%
    mutate(precip_in = cumsum(precip_in_sum)) %>%
    ungroup() %>%
    ggplot(aes(x = doy, y = precip_in, group = station)) +
    geom_step(aes(color = station), size = 1.0) +
    facet_grid(vars(year)) +
    labs(x = "", y = "Cumulative Rainfall (in)") +
    scale_x_continuous(labels = function(x) format(as.Date(as.character(x), "%j"), "%b-%d")) +
    theme(panel.grid.major.y = element_line(color = "gray90", size = 0.75)) +
    theme(legend.position="top") +
    labs(color = "Station")
})
```

Table
=====================================

```{r}
renderDataTable({
  datatable(
    show_weather_df(), 
    rownames = FALSE,
    options = list(scrollY = '400px')
  )
})
```

Map
=====================================

```{r}
leaflet() %>%
#  addTiles() %>%
  setView(-114.001, 46.70, zoom = 13) %>%
  addWMSTiles("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
              layers = "OpenTopoMap") %>%
  addMarkers(lat = stations_df$lat, lng = stations_df$long, 
             popup = paste0(popup = paste0(
                                      "<strong>Station: </strong>", stations_df$station, "<br>",
                                      "<strong>Elevation: </strong>", stations_df$elevation, " ft")),
             label = stations_df$station)
```

About
=====================================

#### About
This is text [link](http://www.example.com)

- one
- two 
- three

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer semper turpis vel faucibus condimentum. Duis consequat lectus at tellus commodo, vel vulputate elit suscipit. Phasellus blandit turpis vitae luctus tempus. Pellentesque non cursus urna, ac ultrices nibh. Suspendisse potenti. Fusce aliquet quis enim ac lacinia. Nam sem nisl, condimentum vitae lobortis ut, tincidunt vitae tortor. Quisque nisl quam, tristique id maximus id, placerat eu justo. Duis laoreet venenatis placerat. Phasellus placerat ipsum sit amet magna dignissim luctus. Nunc pellentesque sit amet velit sed bibendum. Vivamus a vehicula arcu.

Praesent sodales erat nec eros tempor, iaculis egestas urna condimentum. Nam quis facilisis quam. Sed varius lorem vitae sem pellentesque efficitur. Etiam in lacinia odio, a porta arcu. Integer augue leo, vulputate a nibh sit amet, pretium ornare justo. Mauris tristique vestibulum nisi, ut rhoncus lectus pretium at. Nam tristique nibh eget leo hendrerit, a porta nulla scelerisque. Sed dapibus turpis egestas nisi convallis condimentum. Aenean suscipit condimentum aliquet. Suspendisse convallis urna vitae libero fringilla, sed rhoncus ligula accumsan. Duis dapibus auctor neque a sagittis. Pellentesque venenatis vestibulum quam ac porttitor. Vivamus ultricies mauris ligula, non bibendum enim scelerisque non. Aliquam erat volutpat

#### Feedback

Praesent sodales erat nec eros tempor, iaculis egestas urna condimentum. Nam quis facilisis quam. Sed varius lorem vitae sem pellentesque efficitur. Etiam in lacinia odio, a porta arcu. Integer augue leo, vulputate a nibh sit amet, pretium ornare justo. Mauris tristique vestibulum nisi, ut rhoncus lectus pretium at. Nam tristique nibh eget leo hendrerit, a porta nulla scelerisque. Sed dapibus turpis egestas nisi convallis condimentum. Aenean suscipit condimentum aliquet. Suspendisse convallis urna vitae libero fringilla, sed rhoncus ligula accumsan. Duis dapibus auctor neque a sagittis. Pellentesque venenatis vestibulum quam ac porttitor. Vivamus ultricies mauris ligula, non bibendum enim scelerisque non. Aliquam erat volutpat
