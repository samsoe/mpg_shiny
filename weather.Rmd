---
title: "MPG Ranch Weather"
output:
  flexdashboard::flex_dashboard: 
    theme: bootstrap
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(plotly)
library(lubridate)
library(readr)
library(DT)
library(leaflet)
```

```{r load_data, include = FALSE}
weather_df <- read_csv('https://storage.googleapis.com/mpg-data-warehouse/weather_summaries/mpg_ranch_daily/weather_daily_cache.csv')

stations_df <- read_csv('https://storage.googleapis.com/mpg-data-warehouse/weather/MPG/station_meta/weather_station_location.csv')
```

Sidebar {.sidebar data-width=250}
=====================================
```{r}

dateRangeInput("date_range", 
               label = "Date range",
               start = "2013-01-01",
               end = Sys.Date() - 1,
               max = Sys.Date() - 1,
               min = "2013-01-01")

selectInput("station",
            "Select station:",
            choices = c("Baldy Draw", "Baldy Summit", "Indian Ridge",
                        "Orchard House", "Sanfoin Bench", "South Baldy Ridge"),
            selected = c("Baldy Summit", "Orchard House"),
            multiple = TRUE)

sliderInput("day_slider", 
            label = "Day Range by Year:",
            min = 1, 
            max = 365, 
            value = c(1,365), 
            step = 1)

show_weather_df <- reactive({
  weather_df %>%
    filter(date_day >= min(input$date_range) &
            date_day <= max(input$date_range)) %>%
    filter(station %in% if(is.null(input$station)) {'Orchard House'} else {input$station})  %>%
    mutate(doy = yday(date_day)) %>%
    filter(doy >= min(input$day_slider) &
             doy <= max(input$day_slider))
        
})

show_stations_df <- reactive({
  stations_df %>%
      filter(station %in% input$station)
})

# Create placeholder for the downloadButton
uiOutput("downloadUI")

# Create the actual downloadButton
output$downloadUI <- renderUI({
  downloadButton("downBtn", "Download *.csv", style = "width:100%;")
})

# Add download handling
output$downBtn <- downloadHandler(
  filename = function() {
    paste('mpg_weather-', min(input$date_range), '_', max(input$date_range), '.csv', sep='')
  },
  content = function(file) {
    write.csv(show_weather_df(), file, row.names = FALSE)
  }
)
```

Plots
=====================================

Column {.tabset data-width=750}
-----------------
### Temperature

```{r}

renderPlot({
  show_weather_df() %>%
    select(date_day, station, temp_F_mean) %>%
    arrange(date_day) %>%
    mutate(year = year(date_day), doy = yday(date_day)) %>%
    group_by(year, station) %>%
    ungroup() %>%
    ggplot(aes(x=doy, y=temp_F_mean)) +
    geom_line(aes(colour = station)) +
    facet_grid(vars(year)) +
    labs(x = "", y = "Temperature (F)") +
    scale_x_continuous(labels = function(x) format(as.Date(as.character(x), "%j"), "%b-%d")) +
    theme(legend.position="top") +
    labs(color = "Station")
})

```

### Precipitation

```{r}
renderPlot({
  show_weather_df() %>%
    arrange(date_day) %>%
    mutate(year = year(date_day), doy = yday(date_day)) %>%
    group_by(year, station) %>%
    mutate(precip_in = cumsum(precip_in_sum)) %>%
    ungroup() %>%
    ggplot(aes(x = doy, y = precip_in, group = station)) +
    geom_step(aes(color = station), size = 1.0) +
    facet_grid(vars(year)) +
    labs(x = "", y = "Cumulative Rainfall (in)") +
    scale_x_continuous(labels = function(x) format(as.Date(as.character(x), "%j"), "%b-%d")) +
    theme(panel.grid.major.y = element_line(color = "gray90", size = 0.75)) +
    theme(legend.position="top") +
    labs(color = "Station")
})
```

Table
=====================================

```{r}
renderDataTable({
  datatable(
    show_weather_df(), 
    rownames = FALSE,
    options = list(scrollY = '400px')
  )
})
```

Map
=====================================

```{r}
leaflet() %>%
#  addTiles() %>%
  setView(-114.001, 46.70, zoom = 13) %>%
  addWMSTiles("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
              layers = "OpenTopoMap") %>%
  addMarkers(lat = stations_df$lat, lng = stations_df$long, 
             popup = paste0(popup = paste0(
                                      "<strong>Station: </strong>", stations_df$station, "<br>",
                                      "<strong>Elevation: </strong>", stations_df$elevation, " ft")),
             label = stations_df$station)
```

About
=====================================
#### Intention
MPG Ranch has tools which display weather data, but none of them allow users to download data for their own use. In this application, users may filter, view, and *download* weather data from MPG Ranch weather stations.

#### Description
The data are collected from six weather stations, ranging from 3218 to 5994 ft in elevation. The stations record weather variables every 30 minutes. These observations are then loaded into the MPG Ranch Data Warehouse and compiled into daily values. Data included here begin on January 1, 2013, and new data are appended daily.

Known missing data are displayed [here](https://datastudio.google.com/reporting/c55060be-c84b-4547-8556-5107f9a51813){target="_blank"}.

#### Feedback
Please let Beau or Erik know what you think about this application. We appreciate suggestions. Please contact Beau and Erik. If you would like to report bugs or issues, or would like to be involved with development, join us on [GitHub](https://github.com/samsoe/mpg_shiny/issues){target="_blank"}. 